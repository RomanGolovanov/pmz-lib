!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n;n="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,n.pmz=t()}}(function(){return function t(n,e,r){function o(s,a){if(!e[s]){if(!n[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(i)return i(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var f=e[s]={exports:{}};n[s][0].call(f.exports,function(t){var e=n[s][1][t];return o(e?e:t)},f,f.exports,t,n,e,r)}return e[s].exports}for(var i="function"==typeof require&&require,s=0;s<r.length;s++)o(r[s]);return o}({1:[function(t,n,e){"use strict";var r=t("./model/model");e.PmzModel=r.PmzModel;var o=t("./storage/model-file");e.PmzFile=o.PmzFile},{"./model/model":4,"./storage/model-file":14}],2:[function(t,n,e){"use strict";var r=function(){function t(t){this.c=t}return t}();e.PmzColor=r},{}],3:[function(t,n,e){"use strict";var r=function(){function t(t,n,e,r,o,i,s){this.name=t,this.cityName=n,this.countryName=e,this.version=r,this.description=o,this.comment=i,this.delays=s}return t}();e.PmzMetadata=r},{}],4:[function(t,n,e){"use strict";var r=t("./metadata"),o=t("./transport"),i=t("./scheme"),s=function(){function t(t){this.metadata=t,this.transports=[],this.schemes=[]}return t.create=function(){var n=new t(new r.PmzMetadata("Unknown",null,null,"1.0.0",null,null,null));return n.addTransport("Metro.trp",o.PmzTransportType.Metro),n.addScheme("Metro.map"),n},t.prototype.getMetadata=function(){return this.metadata},t.prototype.getSchemes=function(){return this.schemes.map(function(t){return t.name})},t.prototype.addScheme=function(t,n,e){void 0===n&&(n=null),void 0===e&&(e=null),this.schemes.push(new i.PmzScheme(t,t,n||{},e||[]))},t.prototype.removeScheme=function(t){this.schemes.splice(this.schemes.indexOf(this.getScheme(t)))},t.prototype.getScheme=function(t){var n=this.schemes.filter(function(n){return n.name===t});if(n)return n[0];throw new Error("Scheme "+t+" not found")},t.prototype.getTransports=function(){return this.transports.map(function(t){return t.name})},t.prototype.addTransport=function(t,n,e,r){void 0===e&&(e=null),void 0===r&&(r=null),this.transports.push(new o.PmzTransport(t,t,n,e||{},r||{}))},t.prototype.removeTransport=function(t){this.transports.splice(this.transports.indexOf(this.getTransport(t)))},t.prototype.getTransport=function(t){var n=this.transports.filter(function(n){return n.name===t});if(n)return n[0];throw new Error("Transport "+t+" not found")},t}();e.PmzModel=s},{"./metadata":3,"./scheme":8,"./transport":11}],5:[function(t,n,e){"use strict";var r=function(){function t(t,n){this.x=t,this.y=n}return t.prototype.isEmpty=function(){return 0===this.x&&0===this.y},t}();e.PmzPoint=r},{}],6:[function(t,n,e){"use strict";var r=function(){function t(t,n,e,r){this.x=t,this.y=n,this.width=e,this.height=r}return t.prototype.isEmpty=function(){return 0===this.x&&0===this.y&&0===this.width&&0===this.height},t}();e.PmzRect=r},{}],7:[function(t,n,e){"use strict";var r=function(){function t(t,n,e,r,o,i,s,a,u,c,f,l){this.id=t,this.name=n,this.color=e,this.labelColor=r,this.labelBackgroundColor=o,this.coords=i,this.rects=s,this.heights=a,this.rect=u,this.rects2=c,this.splines=f,this.visible=l}return t}();e.PmzSchemeLine=r},{}],8:[function(t,n,e){"use strict";var r=function(){function t(t,n,e,r){this.id=t,this.name=n,this.options=e,this.lines=r}return t}();e.PmzScheme=r},{}],9:[function(t,n,e){"use strict";var r=function(){function t(t,n,e,r,o){return this.line=t,this.src=n,this.dst=e,this.points=r,this.isSmooth=o,this}return t}();e.PmzSpline=r},{}],10:[function(t,n,e){"use strict";var r=function(){function t(t,n){return this.minutes=t,this.seconds=n,this}return t}();e.PmzTime=r},{}],11:[function(t,n,e){"use strict";!function(t){t[t.Metro=0]="Metro",t[t.Bus=1]="Bus"}(e.PmzTransportType||(e.PmzTransportType={}));var r=(e.PmzTransportType,function(){function t(t,n,e,r,o){this.id=t,this.name=n,this.type=e,this.lines=r,this.transfers=o}return t}());e.PmzTransport=r},{}],12:[function(t,n,e){"use strict";function r(t){var n=[];return Object.keys(t).forEach(function(e){n.push("["+e+"]"),Object.keys(t[e]).forEach(function(r){var o=t[e][r];if(o instanceof Array)for(var i=0;i<o.length;i++)n.push(r+"="+o[i]);else n.push(r+"="+o)})}),n.reduce(function(t,n){return t+"\n"+n})}function o(t){var n={section:/^\s*\[\s*([^\]]*)\s*\]\s*$/,param:/^\s*([\w\.\-\_]+)\s*=\s*(.*?)\s*$/,comment:/^\s*;.*$/},e={},r=t.split(/\r\n|\r|\n/),o=null;return r.forEach(function(t){if(!n.comment.test(t))if(n.param.test(t)){var r=t.match(n.param);if(o){var i=e[o][r[1]];i?"string"==typeof i?e[o][r[1]]=[i,r[2]]:e[o][r[1]].push(r[2]):e[o][r[1]]=r[2]}else e[r[1]]=r[2]}else if(n.section.test(t)){var r=t.match(n.section);e[r[1]]={},o=r[1]}else 0==t.length&&o&&(o=null)}),e}e.formatIniText=r,e.parseIniText=o},{}],13:[function(t,n,e){"use strict";function r(t){var n=t.Options,e=(n.DelayNames||"").split("\n");return new i.PmzMetadata(n.Name,n.CityName,n.Country,n.NeedVersion,n.MapAuthors.reduce(function(t,n){return t+"\n"+n}),n.Comment,e)}function o(t){var n={Options:{Name:t.name,CityName:t.cityName||"Unknown",Country:t.countryName||"Unknown",NeedVersion:t.version||"1.0.0",MapAuthors:(t.description||"").split("\n")}};return t.comment&&(n.Options.Comment=t.comment),t.delays&&(n.Options.DelayNames=t.delays.reduce(function(t,n){return t+","+n})),n}var i=t("../model/metadata");e.load=r,e.save=o},{"../model/metadata":3}],14:[function(t,n,e){(function(n){"use strict";function r(t,n){return t?-1!==t.indexOf(n,t.length-n.length):!1}function o(t,n,e){for(var o in t.files){var i=t.files[o];if(r(o,n)&&e(o,i))return}}function i(t,n,e){o(t,n,function(t,n){return e(t,m.parseIniText(u.decodeWindows1251(n.asUint8Array())))})}function s(t){if(-1==["application/x-zip-compressed","application/zip"].indexOf(t.type))throw new TypeError("Invalid file type "+t.type+" for PMZ map");var n=new a(t.content);return o(n,".pmz",function(t,e){return n=new a(e.asArrayBuffer()),!0}),n}var a="undefined"!=typeof window?window.JSZip:"undefined"!=typeof n?n.JSZip:null,u=t("./utils"),c=t("./metadata-file"),f=t("./transport-file"),l=t("./scheme-file"),m=t("./ini-file"),p=t("../model/model"),d=function(){function t(){}return t.load=function(t){var n=s(t),e=null;if(i(n,".cty",function(t,n){e=new p.PmzModel(c.load(n))}),!e)throw new TypeError("Invalid file format");return i(n,".trp",function(t,n){var r=f.load(n,t,e.getMetadata());e.addTransport(r.name,r.options,r.lines,r.transfers)}),i(n,".map",function(t,n){var r=l.load(n,t,e);e.addScheme(r.name,r.options,r.lines)}),e},t.save=function(t,n){var e=s(t),r=c.save(n.metadata),o=m.formatIniText(r),i=u.encodeWindows1251(o);e.file(n.metadata.name+".cty",i),t.content=e.generate({type:"arraybuffer"})},t}();e.PmzFile=d}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../model/model":4,"./ini-file":12,"./metadata-file":13,"./scheme-file":15,"./transport-file":16,"./utils":17}],15:[function(t,n,e){"use strict";function r(t){return t?{imageFileName:t.ImageFileName,stationDiameter:t.StationDiameter,lineWidth:t.LinesWidth,upperCase:t.UpperCase,wordWrap:t.WordWrap,isVector:t.IsVector,transports:l.asArray(t.Transports),checkedTransports:l.asArray(t.CheckedTransports)}:{}}function o(t){if(!t)return{};var n={};for(var e in t){var r=t[e],o=l.asPmzSpline(r);n[o.line]||(n[o.line]=[]),n[o.line].push(o)}return n}function i(t,n){var e=[];for(var r in t){var o=t[r];e.push(new f.PmzSchemeLine(r,r,l.asPmzColor(o.Color),o.LabelsColor,o.LabelsBColor,l.asPmzPointArray(o.Coordinates),l.asPmzRectArray(o.Rects),l.asFloatArray(o.Heights),l.asPmzRect(o.Rect),l.asPmzRectArray(o.Rects2),n[r],!0))}return e}function s(t,n){var e=[];n.getTransports().forEach(function(t){Array.prototype.push.apply(e,Object.keys(n.getTransport(t).lines))});var r={};for(var o in t)-1!==e.indexOf(o)&&(r[o]=t[o]);return r}function a(t,n,e){var a=r(t.Options),u=o(t.AdditionalNodes),f=i(s(t,e),u);return new c.PmzScheme(n,n,a,f)}function u(){throw new TypeError("Not implemented")}var c=t("../model/scheme"),f=t("../model/scheme-line"),l=t("./utils");e.load=a,e.save=u},{"../model/scheme":8,"../model/scheme-line":7,"./utils":17}],16:[function(t,n,e){"use strict";function r(t){return c.PmzTransportType.Metro}function o(t,n){var e={};for(var r in n){var o=n[r],i={};if(o.Delays)for(var s=o.Delays.split(","),a=0;a<t.length;a++)i[t[a]]=s[a];o.DelayDay&&(i.Day=o.DelayDay),o.DelayNight&&(i.Night=o.DelayNight),e[o.Name]={sectionName:r,lineMap:o.LineMap,stations:o.Stations,driving:o.Driving,delays:i}}return e}function i(t){return t}function s(t){var n={};for(var e in t)-1===["Options","Transfers","AdditionalInfo"].indexOf(e)&&(n[e]=t[e]);return n}function a(t,n,e){return new c.PmzTransport(n,n,r(t.Options||{}),o(e.delays,s(t)),i(t.Transfers||{}))}function u(){throw new TypeError("Not implemented")}var c=t("../model/transport");e.load=a,e.save=u},{"../model/transport":11}],17:[function(t,n,e){(function(n){"use strict";function r(t){return t&&"?"!==t?parseInt(t):null}function o(t){return t?t.split(",").map(function(t){return"?"===t?null:t}):[]}function i(t){return o(t).map(function(t){return t?parseInt(t):null})}function s(t){return o(t).map(function(t){return t?parseFloat(t):null})}function a(t){for(var n=i(t),e=[],r=0;r<n.length-1;r+=2)e.push(new v.PmzPoint(n[r],n[r+1]));return e}function u(t){for(var n=i(t),e=[],r=0;r<n.length-3;r+=2)e.push(new w.PmzRect(n[r],n[r+1],n[r+2],n[r+3]));return e}function c(t){var n=i(t);return new v.PmzPoint(n[0],n[1])}function f(t){var n=i(t);return new w.PmzRect(n[0],n[1],n[2],n[3])}function l(t){for(var n=o(t),e=n[0],r=n[1],i=n[2],s=n.length%2===0,a=[],u=3;u<n.length-1;u+=2)a.push(new v.PmzPoint(parseInt(n[u]),parseInt(n[u+1])));return new g.PmzSpline(e,r,i,a,s)}function m(t){if(!t||!t.length)return null;var n=t.split(".");return new P.PmzTime(r(n[0]),2===n.length?r(n[1]):null)}function p(t){return t&&t.length?new z.PmzColor(r(t)):null}function d(t){var n="";return t.forEach(function(t){n+=String.fromCharCode(t)}),y.decode(n,{mode:"fatal"})}function h(t){for(var n=y.encode(t),e=new Uint8Array(n.length),r=0;r<n.length;r++)e[r]=n.charCodeAt(r);return e}var y="undefined"!=typeof window?window.windows1251:"undefined"!=typeof n?n.windows1251:null,v=t("../model/point"),w=t("../model/rect"),P=t("../model/time"),z=t("../model/color"),g=t("../model/spline"),T={DEFAULT_MAP_NAME:"Metro.map",DEFAULT_TRP_NAME:"Metro.trp",DEFAULT_LINE_COLOR:"black"};e.constants=T,e.asArray=o,e.asIntArray=i,e.asFloatArray=s,e.asPmzPointArray=a,e.asPmzRectArray=u,e.asPmzPoint=c,e.asPmzRect=f,e.asPmzSpline=l,e.asPmzTime=m,e.asPmzColor=p,e.decodeWindows1251=d,e.encodeWindows1251=h}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../model/color":2,"../model/point":5,"../model/rect":6,"../model/spline":9,"../model/time":10}]},{},[1])(1)});
//# sourceMappingURL=pmz-lib.min.js.map
