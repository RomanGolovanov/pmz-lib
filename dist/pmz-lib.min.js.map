{"version":3,"sources":["pmz-lib.js"],"names":["f","exports","module","define","amd","g","window","global","self","this","pmz","e","t","n","r","s","o","u","a","require","i","Error","code","l","call","length",1,"model_1","PmzModel","model_file_1","PmzFile","./model/model","./storage/model-file",2,"PmzColor","c",3,"PmzMetadata","name","cityName","countryName","version","description","comment","delays",4,"metadata_1","transport_1","scheme_1","metadata","transports","schemes","create","model","addTransport","PmzTransportType","Metro","addScheme","prototype","getMetadata","getSchemes","map","options","lines","push","PmzScheme","removeScheme","splice","indexOf","getScheme","items","filter","getTransports","type","transfers","PmzTransport","removeTransport","getTransport","./metadata","./scheme","./transport",5,"PmzPoint","x","y","isEmpty",6,"PmzRect","width","height",7,"PmzSchemeLine","id","color","labelColor","labelBackgroundColor","coords","rects","heights","rect","rects2","splines","visible",8,9,"PmzSpline","line","src","dst","points","isSmooth",10,"PmzTime","minutes","seconds",11,12,"formatIniText","ini","Object","keys","forEach","sectionKey","valueKey","value","Array","reduce","parseIniText","text","regex","section","param","split","test","match","currentValue",13,"load","Options","delayNames","Name","CityName","Country","NeedVersion","MapAuthors","save","Comment","DelayNames","../model/metadata",14,"endsWith","suffix","enumerateEntries","zip","ext","callback","entryName","files","zipEntry","enumerateIniEntries","entry","IniFile","PmzUtils","decodeWindows1251","asUint8Array","openZip","file","TypeError","JSZip","content","asArrayBuffer","PmzMetadataFile","PmzTransportFile","PmzSchemeFile","transport","scheme","metaIni","metaText","metaEncoded","encodeWindows1251","generate","../model/model","./ini-file","./metadata-file","./scheme-file","./transport-file","./utils",15,"loadMapOptions","imageFileName","stationDiameter","lineWidth","upperCase","wordWrap","isVector","asArray","checkedTransports","loadSplines","lineNodes","key","item","spline","asPmzSpline","loadMapLines","scheme_line_1","asPmzColor","asPmzPointArray","asPmzRectArray","asFloatArray","asPmzRect","filterLineSections","lineNames","apply","sections","../model/scheme","../model/scheme-line",16,"loadTrpOptions","loadTrpLines","cityDelays","delayValues","Delays","DelayDay","DelayNight","sectionName","lineMap","stations","driving","loadTrpTransfers","filterTrpLineSections","../model/transport",17,"asInt","parseInt","asIntArray","parseFloat","values","point_1","rect_1","asPmzPoint","parts","isSpline","spline_1","asPmzTime","time_1","color_1","buffer","byteString","b","String","fromCharCode","windows1251","decode","mode","asciiEncodedText","encode","Uint8Array","charCodeAt","constants","DEFAULT_MAP_NAME","DEFAULT_TRP_NAME","DEFAULT_LINE_COLOR","../model/color","../model/point","../model/rect","../model/spline","../model/time"],"mappings":"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","file":"pmz-lib.min.js","sourcesContent":["(function(f){if(typeof exports===\"object\"&&typeof module!==\"undefined\"){module.exports=f()}else if(typeof define===\"function\"&&define.amd){define([],f)}else{var g;if(typeof window!==\"undefined\"){g=window}else if(typeof global!==\"undefined\"){g=global}else if(typeof self!==\"undefined\"){g=self}else{g=this}g.pmz = f()}})(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n\"use strict\";\r\nvar model_1 = require(\"./model/model\");\r\nexports.PmzModel = model_1.PmzModel;\r\nvar model_file_1 = require(\"./storage/model-file\");\r\nexports.PmzFile = model_file_1.PmzFile;\r\n\n},{\"./model/model\":4,\"./storage/model-file\":14}],2:[function(require,module,exports){\n\"use strict\";\r\nvar PmzColor = (function () {\r\n    function PmzColor(c) {\r\n        this.c = c;\r\n        ;\r\n    }\r\n    return PmzColor;\r\n}());\r\nexports.PmzColor = PmzColor;\r\n\n},{}],3:[function(require,module,exports){\n\"use strict\";\r\nvar PmzMetadata = (function () {\r\n    function PmzMetadata(name, cityName, countryName, version, description, comment, delays) {\r\n        this.name = name;\r\n        this.cityName = cityName;\r\n        this.countryName = countryName;\r\n        this.version = version;\r\n        this.description = description;\r\n        this.comment = comment;\r\n        this.delays = delays;\r\n    }\r\n    return PmzMetadata;\r\n}());\r\nexports.PmzMetadata = PmzMetadata;\r\n\n},{}],4:[function(require,module,exports){\n\"use strict\";\r\nvar metadata_1 = require('./metadata');\r\nvar transport_1 = require('./transport');\r\nvar scheme_1 = require('./scheme');\r\nvar PmzModel = (function () {\r\n    function PmzModel(metadata) {\r\n        this.metadata = metadata;\r\n        this.transports = [];\r\n        this.schemes = [];\r\n    }\r\n    PmzModel.create = function () {\r\n        var model = new PmzModel(new metadata_1.PmzMetadata('Unknown', null, null, '1.0.0', null, null, null));\r\n        model.addTransport('Metro.trp', transport_1.PmzTransportType.Metro);\r\n        model.addScheme('Metro.map');\r\n        return model;\r\n    };\r\n    PmzModel.prototype.getMetadata = function () {\r\n        return this.metadata;\r\n    };\r\n    PmzModel.prototype.getSchemes = function () {\r\n        return this.schemes.map(function (i) { return i.name; });\r\n    };\r\n    PmzModel.prototype.addScheme = function (name, options, lines) {\r\n        if (options === void 0) { options = null; }\r\n        if (lines === void 0) { lines = null; }\r\n        this.schemes.push(new scheme_1.PmzScheme(name, name, options || {}, lines || []));\r\n    };\r\n    PmzModel.prototype.removeScheme = function (name) {\r\n        this.schemes.splice(this.schemes.indexOf(this.getScheme(name)));\r\n    };\r\n    PmzModel.prototype.getScheme = function (name) {\r\n        var items = this.schemes.filter(function (i) { return i.name === name; });\r\n        if (items) {\r\n            return items[0];\r\n        }\r\n        throw new Error(\"Scheme \" + name + \" not found\");\r\n    };\r\n    PmzModel.prototype.getTransports = function () {\r\n        return this.transports.map(function (i) { return i.name; });\r\n    };\r\n    PmzModel.prototype.addTransport = function (name, type, lines, transfers) {\r\n        if (lines === void 0) { lines = null; }\r\n        if (transfers === void 0) { transfers = null; }\r\n        this.transports.push(new transport_1.PmzTransport(name, name, type, lines || {}, transfers || {}));\r\n    };\r\n    PmzModel.prototype.removeTransport = function (name) {\r\n        this.transports.splice(this.transports.indexOf(this.getTransport(name)));\r\n    };\r\n    PmzModel.prototype.getTransport = function (name) {\r\n        var items = this.transports.filter(function (i) { return i.name === name; });\r\n        if (items) {\r\n            return items[0];\r\n        }\r\n        throw new Error(\"Transport \" + name + \" not found\");\r\n    };\r\n    return PmzModel;\r\n}());\r\nexports.PmzModel = PmzModel;\r\n\n},{\"./metadata\":3,\"./scheme\":8,\"./transport\":11}],5:[function(require,module,exports){\n\"use strict\";\r\nvar PmzPoint = (function () {\r\n    function PmzPoint(x, y) {\r\n        this.x = x;\r\n        this.y = y;\r\n    }\r\n    PmzPoint.prototype.isEmpty = function () {\r\n        return this.x === 0 && this.y === 0;\r\n    };\r\n    return PmzPoint;\r\n}());\r\nexports.PmzPoint = PmzPoint;\r\n\n},{}],6:[function(require,module,exports){\n\"use strict\";\r\nvar PmzRect = (function () {\r\n    function PmzRect(x, y, width, height) {\r\n        this.x = x;\r\n        this.y = y;\r\n        this.width = width;\r\n        this.height = height;\r\n    }\r\n    PmzRect.prototype.isEmpty = function () {\r\n        return this.x === 0 && this.y === 0 && this.width === 0 && this.height === 0;\r\n    };\r\n    return PmzRect;\r\n}());\r\nexports.PmzRect = PmzRect;\r\n\n},{}],7:[function(require,module,exports){\n\"use strict\";\r\nvar PmzSchemeLine = (function () {\r\n    function PmzSchemeLine(id, name, color, labelColor, labelBackgroundColor, coords, rects, heights, rect, rects2, splines, visible) {\r\n        this.id = id;\r\n        this.name = name;\r\n        this.color = color;\r\n        this.labelColor = labelColor;\r\n        this.labelBackgroundColor = labelBackgroundColor;\r\n        this.coords = coords;\r\n        this.rects = rects;\r\n        this.heights = heights;\r\n        this.rect = rect;\r\n        this.rects2 = rects2;\r\n        this.splines = splines;\r\n        this.visible = visible;\r\n    }\r\n    return PmzSchemeLine;\r\n}());\r\nexports.PmzSchemeLine = PmzSchemeLine;\r\n\n},{}],8:[function(require,module,exports){\n\"use strict\";\r\nvar PmzScheme = (function () {\r\n    function PmzScheme(id, name, options, lines) {\r\n        this.id = id;\r\n        this.name = name;\r\n        this.options = options;\r\n        this.lines = lines;\r\n    }\r\n    return PmzScheme;\r\n}());\r\nexports.PmzScheme = PmzScheme;\r\n\n},{}],9:[function(require,module,exports){\n\"use strict\";\r\nvar PmzSpline = (function () {\r\n    function PmzSpline(line, src, dst, points, isSmooth) {\r\n        this.line = line;\r\n        this.src = src;\r\n        this.dst = dst;\r\n        this.points = points;\r\n        this.isSmooth = isSmooth;\r\n        return this;\r\n    }\r\n    return PmzSpline;\r\n}());\r\nexports.PmzSpline = PmzSpline;\r\n\n},{}],10:[function(require,module,exports){\n\"use strict\";\r\nvar PmzTime = (function () {\r\n    function PmzTime(minutes, seconds) {\r\n        this.minutes = minutes;\r\n        this.seconds = seconds;\r\n        return this;\r\n    }\r\n    return PmzTime;\r\n}());\r\nexports.PmzTime = PmzTime;\r\n\n},{}],11:[function(require,module,exports){\n\"use strict\";\r\n(function (PmzTransportType) {\r\n    PmzTransportType[PmzTransportType[\"Metro\"] = 0] = \"Metro\";\r\n    PmzTransportType[PmzTransportType[\"Bus\"] = 1] = \"Bus\";\r\n})(exports.PmzTransportType || (exports.PmzTransportType = {}));\r\nvar PmzTransportType = exports.PmzTransportType;\r\nvar PmzTransport = (function () {\r\n    function PmzTransport(id, name, type, lines, transfers) {\r\n        this.id = id;\r\n        this.name = name;\r\n        this.type = type;\r\n        this.lines = lines;\r\n        this.transfers = transfers;\r\n    }\r\n    return PmzTransport;\r\n}());\r\nexports.PmzTransport = PmzTransport;\r\n\n},{}],12:[function(require,module,exports){\n\"use strict\";\r\nfunction formatIniText(ini) {\r\n    var lines = [];\r\n    Object.keys(ini).forEach(function (sectionKey) {\r\n        lines.push('[' + sectionKey + ']');\r\n        Object.keys(ini[sectionKey]).forEach(function (valueKey) {\r\n            var value = ini[sectionKey][valueKey];\r\n            if (value instanceof Array) {\r\n                for (var i = 0; i < value.length; i++) {\r\n                    lines.push(valueKey + '=' + value[i]);\r\n                }\r\n            }\r\n            else {\r\n                lines.push(valueKey + '=' + value);\r\n            }\r\n        });\r\n    });\r\n    return lines.reduce(function (a, c) { return a + '\\n' + c; });\r\n}\r\nexports.formatIniText = formatIniText;\r\nfunction parseIniText(text) {\r\n    var regex = {\r\n        section: /^\\s*\\[\\s*([^\\]]*)\\s*\\]\\s*$/,\r\n        param: /^\\s*([\\w\\.\\-\\_]+)\\s*=\\s*(.*?)\\s*$/,\r\n        comment: /^\\s*;.*$/\r\n    };\r\n    var value = {};\r\n    var lines = text.split(/\\r\\n|\\r|\\n/);\r\n    var section = null;\r\n    lines.forEach(function (line) {\r\n        if (regex.comment.test(line)) {\r\n            return;\r\n        }\r\n        else if (regex.param.test(line)) {\r\n            var match = line.match(regex.param);\r\n            if (section) {\r\n                var currentValue = value[section][match[1]];\r\n                if (!currentValue) {\r\n                    value[section][match[1]] = match[2];\r\n                }\r\n                else {\r\n                    if (typeof (currentValue) === 'string') {\r\n                        value[section][match[1]] = [currentValue, match[2]];\r\n                    }\r\n                    else {\r\n                        value[section][match[1]].push(match[2]);\r\n                    }\r\n                }\r\n            }\r\n            else {\r\n                value[match[1]] = match[2];\r\n            }\r\n        }\r\n        else if (regex.section.test(line)) {\r\n            var match = line.match(regex.section);\r\n            value[match[1]] = {};\r\n            section = match[1];\r\n        }\r\n        else if (line.length == 0 && section) {\r\n            section = null;\r\n        }\r\n        ;\r\n    });\r\n    return value;\r\n}\r\nexports.parseIniText = parseIniText;\r\n\n},{}],13:[function(require,module,exports){\n\"use strict\";\r\nvar metadata_1 = require('../model/metadata');\r\nfunction load(ini) {\r\n    var options = ini.Options;\r\n    var delayNames = (options['DelayNames'] || '').split('\\n');\r\n    return new metadata_1.PmzMetadata(options.Name, options.CityName, options.Country, options.NeedVersion, options.MapAuthors.reduce(function (a, c) { return a + '\\n' + c; }), options['Comment'], delayNames);\r\n}\r\nexports.load = load;\r\nfunction save(metadata) {\r\n    var ini = {\r\n        Options: {\r\n            Name: metadata.name,\r\n            CityName: metadata.cityName || 'Unknown',\r\n            Country: metadata.countryName || 'Unknown',\r\n            NeedVersion: metadata.version || '1.0.0',\r\n            MapAuthors: (metadata.description || '').split('\\n')\r\n        }\r\n    };\r\n    if (metadata.comment) {\r\n        ini.Options.Comment = metadata.comment;\r\n    }\r\n    if (metadata.delays) {\r\n        ini.Options.DelayNames = metadata.delays.reduce(function (a, c) { return a + ',' + c; });\r\n    }\r\n    return ini;\r\n}\r\nexports.save = save;\r\n\n},{\"../model/metadata\":3}],14:[function(require,module,exports){\n(function (global){\n/// <reference path=\"../../typings/main.d.ts\" />\r\n\"use strict\";\r\nvar JSZip = (typeof window !== \"undefined\" ? window['JSZip'] : typeof global !== \"undefined\" ? global['JSZip'] : null);\r\nvar PmzUtils = require('./utils');\r\nvar PmzMetadataFile = require('./metadata-file');\r\nvar PmzTransportFile = require('./transport-file');\r\nvar PmzSchemeFile = require('./scheme-file');\r\nvar IniFile = require('./ini-file');\r\nvar model_1 = require('../model/model');\r\nfunction endsWith(text, suffix) {\r\n    if (!text) {\r\n        return false;\r\n    }\r\n    return text.indexOf(suffix, text.length - suffix.length) !== -1;\r\n}\r\n;\r\nfunction enumerateEntries(zip, ext, callback) {\r\n    for (var entryName in zip.files) {\r\n        var zipEntry = zip.files[entryName];\r\n        if (endsWith(entryName, ext)) {\r\n            if (callback(entryName, zipEntry)) {\r\n                return;\r\n            }\r\n        }\r\n    }\r\n}\r\nfunction enumerateIniEntries(zip, ext, callback) {\r\n    enumerateEntries(zip, ext, function (name, entry) {\r\n        return callback(name, IniFile.parseIniText(PmzUtils.decodeWindows1251(entry.asUint8Array())));\r\n    });\r\n}\r\nfunction openZip(file) {\r\n    if (['application/x-zip-compressed', 'application/zip'].indexOf(file.type) == -1) {\r\n        throw new TypeError('Invalid file type ' + file.type + ' for PMZ map');\r\n    }\r\n    var zip = new JSZip(file.content);\r\n    enumerateEntries(zip, '.pmz', function (name, entry) {\r\n        zip = new JSZip(entry.asArrayBuffer());\r\n        return true;\r\n    });\r\n    return zip;\r\n}\r\nvar PmzFile = (function () {\r\n    function PmzFile() {\r\n    }\r\n    PmzFile.load = function (file) {\r\n        var zip = openZip(file);\r\n        var model = null;\r\n        enumerateIniEntries(zip, '.cty', function (name, ini) {\r\n            model = new model_1.PmzModel(PmzMetadataFile.load(ini));\r\n        });\r\n        if (!model) {\r\n            throw new TypeError('Invalid file format');\r\n        }\r\n        enumerateIniEntries(zip, '.trp', function (name, ini) {\r\n            var transport = PmzTransportFile.load(ini, name, model.getMetadata());\r\n            model.addTransport(transport.name, transport.options, transport.lines, transport.transfers);\r\n        });\r\n        enumerateIniEntries(zip, '.map', function (name, ini) {\r\n            var scheme = PmzSchemeFile.load(ini, name, model);\r\n            model.addScheme(scheme.name, scheme.options, scheme.lines);\r\n        });\r\n        return model;\r\n    };\r\n    PmzFile.save = function (file, model) {\r\n        var zip = openZip(file);\r\n        var metaIni = PmzMetadataFile.save(model.metadata);\r\n        var metaText = IniFile.formatIniText(metaIni);\r\n        var metaEncoded = PmzUtils.encodeWindows1251(metaText);\r\n        zip.file(model.metadata.name + '.cty', metaEncoded);\r\n        file.content = zip.generate({ type: 'arraybuffer' });\r\n    };\r\n    return PmzFile;\r\n}());\r\nexports.PmzFile = PmzFile;\r\n\n}).call(this,typeof global !== \"undefined\" ? global : typeof self !== \"undefined\" ? self : typeof window !== \"undefined\" ? window : {})\n},{\"../model/model\":4,\"./ini-file\":12,\"./metadata-file\":13,\"./scheme-file\":15,\"./transport-file\":16,\"./utils\":17}],15:[function(require,module,exports){\n\"use strict\";\r\nvar scheme_1 = require('../model/scheme');\r\nvar scheme_line_1 = require('../model/scheme-line');\r\nvar PmzUtils = require('./utils');\r\nfunction loadMapOptions(ini) {\r\n    if (!ini) {\r\n        return {};\r\n    }\r\n    return {\r\n        imageFileName: ini['ImageFileName'],\r\n        stationDiameter: ini['StationDiameter'],\r\n        lineWidth: ini['LinesWidth'],\r\n        upperCase: ini['UpperCase'],\r\n        wordWrap: ini['WordWrap'],\r\n        isVector: ini['IsVector'],\r\n        transports: PmzUtils.asArray(ini['Transports']),\r\n        checkedTransports: PmzUtils.asArray(ini['CheckedTransports'])\r\n    };\r\n}\r\nfunction loadSplines(ini) {\r\n    if (!ini) {\r\n        return {};\r\n    }\r\n    var lineNodes = {};\r\n    for (var key in ini) {\r\n        var item = ini[key];\r\n        var spline = PmzUtils.asPmzSpline(item);\r\n        if (!lineNodes[spline.line]) {\r\n            lineNodes[spline.line] = [];\r\n        }\r\n        lineNodes[spline.line].push(spline);\r\n    }\r\n    return lineNodes;\r\n}\r\nfunction loadMapLines(ini, lineNodes) {\r\n    var lines = [];\r\n    for (var key in ini) {\r\n        var item = ini[key];\r\n        lines.push(new scheme_line_1.PmzSchemeLine(key, key, PmzUtils.asPmzColor(item['Color']), item['LabelsColor'], item['LabelsBColor'], PmzUtils.asPmzPointArray(item['Coordinates']), PmzUtils.asPmzRectArray(item['Rects']), PmzUtils.asFloatArray(item['Heights']), PmzUtils.asPmzRect(item['Rect']), PmzUtils.asPmzRectArray(item['Rects2']), lineNodes[key], true));\r\n    }\r\n    return lines;\r\n}\r\nfunction filterLineSections(ini, model) {\r\n    var lineNames = [];\r\n    model.getTransports().forEach(function (key) {\r\n        Array.prototype.push.apply(lineNames, Object.keys(model.getTransport(key).lines));\r\n    });\r\n    var sections = {};\r\n    for (var key in ini) {\r\n        if (lineNames.indexOf(key) !== -1) {\r\n            sections[key] = ini[key];\r\n        }\r\n    }\r\n    return sections;\r\n}\r\nfunction load(ini, name, model) {\r\n    var options = loadMapOptions(ini['Options']);\r\n    var splines = loadSplines(ini['AdditionalNodes']);\r\n    var lines = loadMapLines(filterLineSections(ini, model), splines);\r\n    return new scheme_1.PmzScheme(name, name, options, lines);\r\n}\r\nexports.load = load;\r\nfunction save() {\r\n    throw new TypeError('Not implemented');\r\n}\r\nexports.save = save;\r\n\n},{\"../model/scheme\":8,\"../model/scheme-line\":7,\"./utils\":17}],16:[function(require,module,exports){\n\"use strict\";\r\nvar transport_1 = require('../model/transport');\r\nfunction loadTrpOptions(ini) {\r\n    return transport_1.PmzTransportType.Metro; // TODO: fix it\r\n}\r\nfunction loadTrpLines(cityDelays, ini) {\r\n    var lines = {};\r\n    for (var key in ini) {\r\n        var item = ini[key];\r\n        var delays = {};\r\n        if (item['Delays']) {\r\n            var delayValues = item.Delays.split(',');\r\n            for (var i = 0; i < cityDelays.length; i++) {\r\n                delays[cityDelays[i]] = delayValues[i];\r\n            }\r\n        }\r\n        if (item['DelayDay']) {\r\n            delays['Day'] = item.DelayDay;\r\n        }\r\n        if (item['DelayNight']) {\r\n            delays['Night'] = item.DelayNight;\r\n        }\r\n        lines[item.Name] = {\r\n            sectionName: key,\r\n            lineMap: item['LineMap'],\r\n            stations: item['Stations'],\r\n            driving: item['Driving'],\r\n            delays: delays\r\n        };\r\n    }\r\n    return lines;\r\n}\r\nfunction loadTrpTransfers(ini) {\r\n    return ini;\r\n}\r\nfunction filterTrpLineSections(ini) {\r\n    var sections = {};\r\n    for (var key in ini) {\r\n        if (['Options', 'Transfers', 'AdditionalInfo'].indexOf(key) === -1) {\r\n            sections[key] = ini[key];\r\n        }\r\n    }\r\n    return sections;\r\n}\r\nfunction load(ini, name, metadata) {\r\n    return new transport_1.PmzTransport(name, name, loadTrpOptions(ini['Options'] || {}), loadTrpLines(metadata.delays, filterTrpLineSections(ini)), loadTrpTransfers(ini['Transfers'] || {}));\r\n}\r\nexports.load = load;\r\nfunction save() {\r\n    throw new TypeError('Not implemented');\r\n}\r\nexports.save = save;\r\n\n},{\"../model/transport\":11}],17:[function(require,module,exports){\n(function (global){\n/// <reference path=\"../../typings/main.d.ts\" />\r\n\"use strict\";\r\nvar windows1251 = (typeof window !== \"undefined\" ? window['windows1251'] : typeof global !== \"undefined\" ? global['windows1251'] : null);\r\nvar point_1 = require('../model/point');\r\nvar rect_1 = require('../model/rect');\r\nvar time_1 = require('../model/time');\r\nvar color_1 = require('../model/color');\r\nvar spline_1 = require('../model/spline');\r\nvar constants = {\r\n    DEFAULT_MAP_NAME: 'Metro.map',\r\n    DEFAULT_TRP_NAME: 'Metro.trp',\r\n    DEFAULT_LINE_COLOR: 'black'\r\n};\r\nexports.constants = constants;\r\nfunction asInt(text) {\r\n    return text && text !== '?' ? parseInt(text) : null;\r\n}\r\nfunction asArray(text) {\r\n    if (!text)\r\n        return [];\r\n    return text.split(',').map(function (item) {\r\n        return item === '?' ? null : item;\r\n    });\r\n}\r\nexports.asArray = asArray;\r\nfunction asIntArray(text) {\r\n    return asArray(text).map(function (item) {\r\n        if (!item)\r\n            return null;\r\n        return parseInt(item);\r\n    });\r\n}\r\nexports.asIntArray = asIntArray;\r\nfunction asFloatArray(text) {\r\n    return asArray(text).map(function (item) {\r\n        if (!item)\r\n            return null;\r\n        return parseFloat(item);\r\n    });\r\n}\r\nexports.asFloatArray = asFloatArray;\r\nfunction asPmzPointArray(text) {\r\n    var values = asIntArray(text);\r\n    var points = [];\r\n    for (var i = 0; i < (values.length - 1); i += 2) {\r\n        points.push(new point_1.PmzPoint(values[i], values[i + 1]));\r\n    }\r\n    return points;\r\n}\r\nexports.asPmzPointArray = asPmzPointArray;\r\nfunction asPmzRectArray(text) {\r\n    var values = asIntArray(text);\r\n    var rects = [];\r\n    for (var i = 0; i < (values.length - 3); i += 2) {\r\n        rects.push(new rect_1.PmzRect(values[i], values[i + 1], values[i + 2], values[i + 3]));\r\n    }\r\n    return rects;\r\n}\r\nexports.asPmzRectArray = asPmzRectArray;\r\nfunction asPmzPoint(text) {\r\n    var values = asIntArray(text);\r\n    return new point_1.PmzPoint(values[0], values[1]);\r\n}\r\nexports.asPmzPoint = asPmzPoint;\r\nfunction asPmzRect(text) {\r\n    var values = asIntArray(text);\r\n    return new rect_1.PmzRect(values[0], values[1], values[2], values[3]);\r\n}\r\nexports.asPmzRect = asPmzRect;\r\nfunction asPmzSpline(text) {\r\n    var parts = asArray(text);\r\n    var line = parts[0];\r\n    var src = parts[1];\r\n    var dst = parts[2];\r\n    var isSpline = parts.length % 2 === 0;\r\n    var points = [];\r\n    for (var i = 3; i < (parts.length - 1); i += 2) {\r\n        points.push(new point_1.PmzPoint(parseInt(parts[i]), parseInt(parts[i + 1])));\r\n    }\r\n    return new spline_1.PmzSpline(line, src, dst, points, isSpline);\r\n}\r\nexports.asPmzSpline = asPmzSpline;\r\nfunction asPmzTime(text) {\r\n    if (!text || !text.length) {\r\n        return null;\r\n    }\r\n    var parts = text.split('.');\r\n    return new time_1.PmzTime(asInt(parts[0]), parts.length === 2 ? asInt(parts[1]) : null);\r\n}\r\nexports.asPmzTime = asPmzTime;\r\nfunction asPmzColor(text) {\r\n    if (!text || !text.length) {\r\n        return null;\r\n    }\r\n    return new color_1.PmzColor(asInt(text));\r\n}\r\nexports.asPmzColor = asPmzColor;\r\nfunction decodeWindows1251(buffer) {\r\n    var byteString = '';\r\n    buffer.forEach(function (b) {\r\n        byteString = byteString + String.fromCharCode(b);\r\n    });\r\n    return windows1251.decode(byteString, { 'mode': 'fatal' });\r\n}\r\nexports.decodeWindows1251 = decodeWindows1251;\r\nfunction encodeWindows1251(text) {\r\n    var asciiEncodedText = windows1251.encode(text);\r\n    var buffer = new Uint8Array(asciiEncodedText.length);\r\n    for (var i = 0; i < asciiEncodedText.length; i++) {\r\n        buffer[i] = asciiEncodedText.charCodeAt(i);\r\n    }\r\n    return buffer;\r\n}\r\nexports.encodeWindows1251 = encodeWindows1251;\r\n\n}).call(this,typeof global !== \"undefined\" ? global : typeof self !== \"undefined\" ? self : typeof window !== \"undefined\" ? window : {})\n},{\"../model/color\":2,\"../model/point\":5,\"../model/rect\":6,\"../model/spline\":9,\"../model/time\":10}]},{},[1])(1)\n});"],"sourceRoot":"/source/"}