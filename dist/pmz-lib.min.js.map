{"version":3,"sources":["pmz-lib.js"],"names":["f","exports","module","define","amd","g","window","global","self","this","pmz","e","t","n","r","s","o","u","a","require","i","Error","code","l","call","length",1,"PmzPoint","x","y","prototype","isEmpty",2,"PmzRect","width","height",3,"PmzTime","minutes","seconds",4,"asInt","text","parseInt","asArray","split","map","item","asIntArray","asFloatArray","parseFloat","windows1251","constants","DEFAULT_MAP_NAME","DEFAULT_TRP_NAME","DEFAULT_LINE_COLOR","asPmzPointArray","values","points","push","asPmzRectArray","rects","asPmzPoint","asPmzRect","asAdditionalNodes","parts","line","src","dst","isSpline","PmzAdditionNodes","asPmzTime","asColor","decodeWindows1251","buffer","byteString","forEach","b","String","fromCharCode","decode","mode","encodeWindows1251","asciiEncodedText","encode","Uint8Array","charCodeAt","./point","./rect","./time",5,"Model","File","./model/model","./storage/model-file",6,7,"PmzMetadata","name","cityName","countryName","version","description","comment","delays",8,"PmzModel","metadata","transports","schemes","PmzScheme","PmzTransport","create","model","addTransport","addScheme","getMetadata","getSchemes","Object","keys","options","lines","removeScheme","getScheme","getTransports","type","transfers","removeTransport","getTransport","./metadata","./scheme","./transport",9,"PmzSchemeLine","id","color","labelColor","labelBackgroundColor","coords","heights","rect","rects2","nodes","visible",10,11,12,"formatIniText","ini","sectionKey","valueKey","value","Array","reduce","c","parseIniText","regex","section","param","test","match","currentValue",13,"load","Options","delayNames","Name","CityName","Country","NeedVersion","MapAuthors","save","Comment","DelayNames","../model/metadata",14,"enumerateEntries","zip","ext","callback","entryName","files","zipEntry","endsWith","enumerateIniEntries","entry","IniFile","PmzUtils","asUint8Array","openZip","file","indexOf","TypeError","JSZip","content","asArrayBuffer","PmzMetadataFile","transport","PmzTransportFile","scheme","PmzSchemeFile","metaIni","metaText","metaEncoded","generate","../common/utils","../model/model","./ini-file","./metadata-file","./scheme-file","./transport-file",15,"loadMapOptions","imageFileName","stationDiameter","lineWidth","upperCase","wordWrap","isVector","checkedTransports","loadAdditionalNodes","lineNodes","key","node","loadMapLines","filterLineSections","lineNames","apply","sections","additionalNodes","../common/point","../model/additional-nodes","../model/scheme","../model/scheme-line",16,"loadTrpOptions","loadTrpLines","cityDelays","delayValues","Delays","DelayDay","DelayNight","sectionName","lineMap","stations","driving","loadTrpTransfers","filterTrpLineSections","../model/transport"],"mappings":"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","file":"pmz-lib.min.js","sourcesContent":["(function(f){if(typeof exports===\"object\"&&typeof module!==\"undefined\"){module.exports=f()}else if(typeof define===\"function\"&&define.amd){define([],f)}else{var g;if(typeof window!==\"undefined\"){g=window}else if(typeof global!==\"undefined\"){g=global}else if(typeof self!==\"undefined\"){g=self}else{g=this}g.pmz = f()}})(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n'use strict';\r\n\r\nfunction PmzPoint(x,y){\r\n\tthis.x = x;\r\n\tthis.y = y;\r\n\treturn this;\r\n}\r\n\r\nPmzPoint.prototype.isEmpty = function(){\r\n\treturn this.x === 0 && this.y === 0;\r\n};\r\n\r\nmodule.exports = PmzPoint;\r\n\n},{}],2:[function(require,module,exports){\n'use strict';\r\n\r\nfunction PmzRect(x,y,width,height){\r\n\tthis.x = x;\r\n\tthis.y = y;\r\n\tthis.width = width;\r\n\tthis.height = height;\r\n\treturn this;\r\n}\r\n\r\nPmzRect.prototype.isEmpty = function(){\r\n\treturn this.x === 0 && this.y === 0 && this.width === 0 && this.height === 0;\r\n};\r\n\r\nmodule.exports = PmzRect;\r\n\n},{}],3:[function(require,module,exports){\n'use strict';\r\n\r\nfunction PmzTime(minutes, seconds){\r\n\tthis.minutes = minutes;\r\n\tthis.seconds = seconds;\r\n\treturn this;\r\n}\r\n\r\nmodule.exports = PmzTime;\r\n\n},{}],4:[function(require,module,exports){\n(function (global){\n'use strict';\r\n\r\nvar windows1251 = (typeof window !== \"undefined\" ? window['windows1251'] : typeof global !== \"undefined\" ? global['windows1251'] : null),\r\n\tPmzPoint = require('./point'),\r\n\tPmzRect = require('./rect'),\r\n\tPmzTime = require('./time');\r\n\r\nfunction asInt(text){\r\n\treturn text && text!=='?' ? parseInt(text) : null;\r\n}\r\n\r\nfunction asArray(text){\r\n\tif(!text) return [];\r\n\treturn text.split(',').map(function(item){ \r\n\t\treturn item === '?' ? null : item; \r\n\t});\r\n}\r\n\r\nfunction asIntArray(text){\r\n\treturn asArray(text).map(function(item){ \r\n\t\tif(!item) return null;\r\n\t\treturn parseInt(item); \r\n\t});\r\n}\r\n\r\nfunction asFloatArray(text){\r\n\treturn asArray(text).map(function(item){ \r\n\t\tif(!item) return null;\r\n\t\treturn parseFloat(item); \r\n\t});\r\n}\r\n\r\nmodule.exports = {\r\n    constants: {\r\n        DEFAULT_MAP_NAME: 'Metro.map',\r\n        DEFAULT_TRP_NAME: 'Metro.trp',\r\n        DEFAULT_LINE_COLOR: 'black'\r\n    },\r\n\r\n\tasArray: asArray,\r\n\r\n\tasIntArray: asIntArray,\r\n    \r\n\tasFloatArray: asFloatArray,\r\n\r\n\tasPmzPointArray: function(text){\r\n\t\tvar values = asIntArray(text);\r\n\t\tvar points = [];\r\n\t\tfor(var i =0; i<(values.length-1); i+=2){\r\n\t\t\tpoints.push(new PmzPoint(values[i],values[i+1]));\r\n\t\t}\r\n\t\treturn points;\r\n\t},\r\n\r\n\tasPmzRectArray: function(text){\r\n\t\tvar values = asIntArray(text);\r\n\t\tvar rects = [];\r\n\t\tfor(var i =0; i<(values.length-3); i+=2){\r\n\t\t\trects.push(new PmzRect(values[i],values[i+1],values[i+2],values[i+3]));\r\n\t\t}\r\n\t\treturn rects;\r\n\t},\r\n\r\n\tasPmzPoint: function(text){\r\n\t\tvar values = asIntArray(text);\r\n\t\treturn new PmzPoint(values[0],values[1]);\r\n\t},\r\n\r\n\tasPmzRect: function(text){\r\n\t\tvar values = asIntArray(text);\r\n\t\treturn new PmzRect(values[0],values[1],values[2],values[3]);\r\n\t},\r\n\r\n\tasAdditionalNodes: function(text){\r\n        var parts = asArray(text);\r\n\r\n        var line = parts[0];\r\n        var src = parts[1];\r\n        var dst = parts[2];\r\n        var isSpline = parts.length % 2 === 0;\r\n        var points = [];\r\n        for(var i=3;i<(parts.length-1); i+=2){\r\n        \tpoints.push(new PmzPoint(parseInt(parts[i]), parseInt(parts[i+1])));\r\n        }\r\n\t\treturn new PmzAdditionNodes(line, src, dst, points, isSpline);\r\n\t},\r\n\r\n\tasPmzTime: function(text){\r\n\t\tif(!text || !text.length){\r\n\t\t\treturn null;\r\n\t\t}\r\n\t\tvar parts = text.split('.');\r\n\t\treturn new PmzTime(asInt(parts[0]), \r\n\t\t\tparts.length === 2 ? asInt(parts[1]) : null);\r\n\t},\r\n\r\n    asColor: function(text){\r\n        if(!text || !text.length){\r\n            return null;\r\n        }\r\n        return '#' + text;\r\n    },\r\n\r\n    decodeWindows1251 : function (buffer){\r\n        var byteString = '';\r\n        buffer.forEach(function(b){ \r\n            byteString = byteString + String.fromCharCode(b); \r\n        });\r\n        return windows1251.decode(byteString, { 'mode': 'fatal' });\r\n    },\r\n\r\n    encodeWindows1251 : function (text){\r\n        var asciiEncodedText = windows1251.encode(text);\r\n        var buffer = new Uint8Array(asciiEncodedText.length);\r\n        for(var i=0;i<asciiEncodedText.length;i++){\r\n            buffer[i] = asciiEncodedText.charCodeAt(i);\r\n        }\r\n        return buffer;\r\n    }\r\n\r\n};\r\n\n}).call(this,typeof global !== \"undefined\" ? global : typeof self !== \"undefined\" ? self : typeof window !== \"undefined\" ? window : {})\n},{\"./point\":1,\"./rect\":2,\"./time\":3}],5:[function(require,module,exports){\n'use strict';\r\n\r\nmodule.exports.Model = require('./model/model');\r\n\r\nmodule.exports.File = require('./storage/model-file');\r\n\r\n\n},{\"./model/model\":8,\"./storage/model-file\":14}],6:[function(require,module,exports){\n'use strict';\r\n\r\nfunction PmzAdditionNodes(line, src, dst, points, isSpline){\r\n\tthis.line = line;\r\n\tthis.src = src;\r\n\tthis.dst = dst;\r\n\tthis.points = points;\r\n\tthis.isSpline = isSpline;\r\n\treturn this;\r\n}\r\n\r\nmodule.exports = PmzAdditionNodes;\r\n\n},{}],7:[function(require,module,exports){\n'use strict';\r\n\r\nfunction PmzMetadata(name, cityName, countryName, version, description, comment, delays){\r\n\tvar self = this;\r\n\r\n\tthis.name = name;\r\n\tthis.cityName = cityName;\r\n\tthis.countryName = countryName;\r\n\tthis.version = version;\r\n\tthis.description = description;\r\n\tthis.comment = comment;\r\n\tthis.delays = delays;\r\n\r\n\treturn this;\r\n}\r\n\r\nmodule.exports = PmzMetadata;\r\n\n},{}],8:[function(require,module,exports){\n'use strict';\r\n\r\nvar PmzMetadata = require('./metadata'),\r\n\tPmzScheme = require('./scheme'),\r\n\tPmzTransport = require('./transport');\r\n\r\n\r\nfunction PmzModel(metadata){\r\n\tthis.metadata = metadata;\r\n\tthis.transports = {};\r\n\tthis.schemes = {};\r\n\treturn this;\r\n}\r\n\r\n\r\nPmzModel.create = function(){\r\n\tvar model = new PmzModel(new PmzMetadata('Unknown', null, null, '1.0.0'));\r\n\tmodel.addTransport('Metro.trp', 'Метро');\r\n\tmodel.addScheme('Metro.map');\r\n\treturn model;\r\n};\r\n\r\n\r\nPmzModel.prototype.getMetadata = function(){\r\n\treturn this.metadata;\r\n};\r\n\r\n\r\nPmzModel.prototype.getSchemes = function(){\r\n\treturn Object.keys(this.schemes);\r\n};\r\n\r\nPmzModel.prototype.addScheme = function(name, options, lines){\r\n\tthis.schemes[name] = new PmzScheme(name, name, options || {}, lines || {});\r\n};\r\n\r\nPmzModel.prototype.removeScheme = function(name){\r\n\tdelete this.schemes[name];\r\n};\r\n\r\nPmzModel.prototype.getScheme = function(name){\r\n\treturn this.schemes[name];\r\n};\r\n\r\n\r\nPmzModel.prototype.getTransports = function(){\r\n\treturn Object.keys(this.transports);\r\n};\r\n\r\nPmzModel.prototype.addTransport = function(name, type, lines, transfers){\r\n\tthis.transports[name] = new PmzTransport(name, name, { type: type }, lines || {}, transfers || {});\r\n};\r\n\r\nPmzModel.prototype.removeTransport = function(name){\r\n\tdelete this.transports[name];\r\n};\r\n\r\nPmzModel.prototype.getTransport = function(name){\r\n\treturn this.transports[name];\r\n};\r\n\r\nmodule.exports = PmzModel;\r\n\n},{\"./metadata\":7,\"./scheme\":10,\"./transport\":11}],9:[function(require,module,exports){\n'use strict';\r\n\r\nfunction PmzSchemeLine(id, name, color, labelColor, labelBackgroundColor, coords, rects, heights, rect, rects2, nodes, visible){\r\n\tthis.id = id;\r\n\tthis.name = name;\r\n\r\n\tthis.color = color;\r\n\tthis.labelColor = labelColor;\r\n\tthis.labelBackgroundColor = labelBackgroundColor;\r\n\tthis.coords = coords || [];\r\n\tthis.rects = rects || [];\r\n\tthis.heights = heights || [];\r\n\tthis.rect = rect;\r\n\tthis.rects2 = rects2 || [];\r\n\tthis.nodes = nodes || [];\r\n\tthis.visible = visible;\r\n\treturn this;\r\n}\r\n\r\nmodule.exports = PmzSchemeLine;\r\n\n},{}],10:[function(require,module,exports){\n'use strict';\r\n\r\nfunction PmzScheme(id, name, options, lines){\r\n\tthis.id = id;\r\n\tthis.name = name;\r\n\tthis.options = options;\r\n\tthis.lines = lines;\r\n\treturn this;\r\n}\r\n\r\nmodule.exports = PmzScheme;\r\n\n},{}],11:[function(require,module,exports){\n'use strict';\r\n\r\nfunction PmzTransport(id, name, options, lines, transfers){\r\n\tthis.id = id;\r\n\tthis.name = name;\r\n\tthis.options = options;\r\n\tthis.lines = lines;\r\n\tthis.transfers = transfers;\r\n\treturn this;\r\n}\r\n\r\nmodule.exports = PmzTransport;\r\n\n},{}],12:[function(require,module,exports){\n'use strict';\r\n\r\nmodule.exports.formatIniText = function(ini){\r\n    var lines = [];\r\n    Object.keys(ini).forEach(function(sectionKey){\r\n        lines.push('[' + sectionKey + ']');\r\n        Object.keys(ini[sectionKey]).forEach(function(valueKey){\r\n            var value = ini[sectionKey][valueKey];\r\n            if(value instanceof Array){\r\n                for(var i=0;i<value.length;i++){\r\n                lines.push(valueKey + '=' + value[i]);\r\n                }\r\n            }else{\r\n                lines.push(valueKey + '=' + value);\r\n            }\r\n        });\r\n    });\r\n    return lines.reduce(function(a,c){ return a+'\\n'+c; });\r\n};\r\n\r\nmodule.exports.parseIniText = function(text){\r\n    var regex = {\r\n        section: /^\\s*\\[\\s*([^\\]]*)\\s*\\]\\s*$/,\r\n        param: /^\\s*([\\w\\.\\-\\_]+)\\s*=\\s*(.*?)\\s*$/,\r\n        comment: /^\\s*;.*$/\r\n    };\r\n    var value = {};\r\n    var lines = text.split(/\\r\\n|\\r|\\n/);\r\n    var section = null;\r\n    lines.forEach(function(line){\r\n        if(regex.comment.test(line)){\r\n            return;\r\n        }else if(regex.param.test(line)){\r\n            var match = line.match(regex.param);\r\n            if(section){\r\n                var currentValue = value[section][match[1]];\r\n                if(!currentValue){\r\n                    value[section][match[1]] = match[2];\r\n                }else{\r\n                    if(typeof(currentValue)==='string'){\r\n                        value[section][match[1]] = [currentValue, match[2]];\r\n                    }else{\r\n                        value[section][match[1]].push(match[2]);\r\n                    }\r\n                }\r\n\r\n\r\n\r\n            }else{\r\n                value[match[1]] = match[2];\r\n            }\r\n        }else if(regex.section.test(line)){\r\n            var match = line.match(regex.section);\r\n            value[match[1]] = {};\r\n            section = match[1];\r\n        }else if(line.length == 0 && section){\r\n            section = null;\r\n        };\r\n    });\r\n    return value;\r\n};\r\n\n},{}],13:[function(require,module,exports){\n'use strict';\r\n\r\nvar PmzMetadata = require('../model/metadata');\r\n\r\nfunction load(ini){\r\n    var options = ini.Options;\r\n\r\n    var delayNames = (options['DelayNames'] || '').split('\\n');\r\n    return new PmzMetadata(\r\n        options.Name,\r\n        options.CityName,\r\n        options.Country,\r\n        options.NeedVersion,\r\n        options.MapAuthors.reduce(function(a, c) { return a + '\\n' + c; }),\r\n        options['Comment'],\r\n        delayNames);\r\n}\r\n\r\nfunction save(metadata){\r\n    var ini = { \r\n        Options: {\r\n            Name: metadata.name,\r\n            CityName: metadata.cityName || 'Unknown',\r\n            Country: metadata.countryName || 'Unknown',\r\n            NeedVersion: metadata.version || '1.0.0',\r\n            MapAuthors: (metadata.description || '').split('\\n'),\r\n        }\r\n    };\r\n    if(metadata.comment){\r\n        ini.Options.Comment = metadata.comment;\r\n    }\r\n    if(metadata.delays){\r\n        ini.Options.DelayNames = metadata.delays.reduce(function(a,c){ return a + ',' + c; });\r\n    }\r\n    return ini;\r\n}\r\n\r\nmodule.exports.load = load;\r\n\r\nmodule.exports.save = save;\r\n\n},{\"../model/metadata\":7}],14:[function(require,module,exports){\n(function (global){\n'use strict';\r\n\r\nvar JSZip = (typeof window !== \"undefined\" ? window['JSZip'] : typeof global !== \"undefined\" ? global['JSZip'] : null),\r\n    IniFile = require('./ini-file'),\r\n    PmzUtils = require('../common/utils'),\r\n    PmzModel = require('../model/model'),\r\n    PmzMetadataFile = require('./metadata-file'),\r\n    PmzTransportFile = require('./transport-file'),\r\n    PmzSchemeFile = require('./scheme-file');\r\n\r\n\r\nfunction enumerateEntries(zip, ext, callback){\r\n    for(var entryName in zip.files){\r\n        var zipEntry = zip.files[entryName];\r\n        if(entryName.endsWith(ext)){\r\n            if(callback(entryName, zipEntry)){\r\n                return;\r\n            }\r\n        }\r\n    }        \r\n}\r\n\r\nfunction enumerateIniEntries(zip, ext, callback){\r\n    enumerateEntries(zip, ext, function(name, entry){\r\n        return callback(name, IniFile.parseIniText(\r\n            PmzUtils.decodeWindows1251(entry.asUint8Array())));\r\n    });\r\n}\r\n\r\nfunction openZip(file){\r\n    if(['application/x-zip-compressed', 'application/zip'].indexOf(file.type)==-1){\r\n        throw new TypeError('Invalid file type ' + file.type + ' for PMZ map');\r\n    }\r\n    var zip = new JSZip(file.content);\r\n    enumerateEntries(zip, '.pmz', function(name, entry){ \r\n        zip = new JSZip(entry.asArrayBuffer()); \r\n        return true;\r\n    });\r\n    return zip;\r\n}\r\n\r\nfunction load(file){\r\n\r\n    var zip = openZip(file);\r\n\r\n    var model = null;\r\n    enumerateIniEntries(zip, '.cty', function(name, ini){\r\n        model = new PmzModel(PmzMetadataFile.load(ini));\r\n    });\r\n\r\n    if(!model){\r\n        throw new TypeError('Invalid file format');\r\n    }\r\n\r\n    enumerateIniEntries(zip, '.trp', function(name, ini){\r\n        var transport = PmzTransportFile.load(ini, name, model.getMetadata());\r\n        model.addTransport(transport.name, transport.options, transport.lines, transport.transfers);\r\n    });\r\n\r\n    enumerateIniEntries(zip, '.map', function(name, ini){\r\n        var scheme = PmzSchemeFile.load(ini, name, model);\r\n        model.addScheme(scheme.name, scheme.options, scheme.lines);\r\n    });\r\n\r\n    return model;\r\n}\r\n\r\nfunction save(file, model){\r\n    var zip = openZip(file);\r\n    \r\n    var metaIni = PmzMetadataFile.save(model.metadata);\r\n    var metaText = IniFile.formatIniText(metaIni);\r\n    var metaEncoded = PmzUtils.encodeWindows1251(metaText);\r\n    zip.file(model.metadata.name + '.cty', metaEncoded);\r\n\r\n    file.content = zip.generate({type:'arraybuffer'});\r\n}\r\n\r\nmodule.exports.load = load;\r\n\r\nmodule.exports.save = save;\r\n\n}).call(this,typeof global !== \"undefined\" ? global : typeof self !== \"undefined\" ? self : typeof window !== \"undefined\" ? window : {})\n},{\"../common/utils\":4,\"../model/model\":8,\"./ini-file\":12,\"./metadata-file\":13,\"./scheme-file\":15,\"./transport-file\":16}],15:[function(require,module,exports){\n'use strict';\r\n\r\nvar PmzUtils = require('../common/utils'),\r\n    PmzPoint = require('../common/point'),\r\n    PmzScheme = require('../model/scheme'),\r\n    PmzSchemeLine = require('../model/scheme-line'),\r\n    PmzAdditionNodes = require('../model/additional-nodes');\r\n\r\n\r\nfunction asAdditionalNodes(text){\r\n    var parts = PmzUtils.asArray(text);\r\n\r\n    var line = parts[0];\r\n    var src = parts[1];\r\n    var dst = parts[2];\r\n    var isSpline = parts.length % 2 === 0;\r\n    var points = [];\r\n    for(var i=3;i<(parts.length-1); i+=2){\r\n        points.push(new PmzPoint(parseInt(parts[i]), parseInt(parts[i+1])));\r\n    }\r\n    return new PmzAdditionNodes(line, src, dst, points, isSpline);\r\n}\r\n\r\nfunction loadMapOptions(ini){\r\n    if(!ini){\r\n        return {};\r\n    }\r\n\r\n    return {\r\n        imageFileName: ini['ImageFileName'],\r\n        stationDiameter: ini['StationDiameter'],\r\n        lineWidth: ini['LinesWidth'],\r\n        upperCase: ini['UpperCase'],\r\n        wordWrap: ini['WordWrap'],\r\n        isVector: ini['IsVector'],\r\n        transports: PmzUtils.asArray(ini['Transports']),\r\n        checkedTransports: PmzUtils.asArray(ini['CheckedTransports'])\r\n    };\r\n}\r\n\r\nfunction loadAdditionalNodes(ini){\r\n    if(!ini){\r\n        return {};\r\n    }\r\n\r\n    var lineNodes = {};\r\n    for(var key in ini){\r\n        var item = ini[key];\r\n        var node = asAdditionalNodes(item);\r\n        if(!lineNodes[node.line]){\r\n            lineNodes[node.line] = [];\r\n        }\r\n        lineNodes[node.line].push(asAdditionalNodes(item));\r\n    }\r\n    return lineNodes;\r\n}\r\n\r\nfunction loadMapLines(ini, lineNodes){\r\n    var lines = {};\r\n    for(var key in ini){\r\n        var item = ini[key];\r\n\r\n        lines[key] = new PmzSchemeLine(key, key,\r\n            PmzUtils.asColor(item['Color']),\r\n            item['LabelsColor'],\r\n            item['LabelsBColor'],\r\n            PmzUtils.asPmzPointArray(item['Coordinates']),\r\n            PmzUtils.asPmzRectArray(item['Rects']),\r\n            PmzUtils.asFloatArray(item['Heights']),\r\n            PmzUtils.asPmzRect(item['Rect']),\r\n            PmzUtils.asPmzRectArray(item['Rects2']),\r\n            lineNodes[key] || [],\r\n            true );\r\n    }\r\n    return lines;\r\n}\r\n\r\nfunction filterLineSections(ini, model){\r\n    var lineNames = [];\r\n\r\n    model.getTransports().forEach(function(key){\r\n        Array.prototype.push.apply(lineNames, Object.keys(model.getTransport(key).lines));\r\n    });\r\n\r\n    var sections = {};\r\n    for(var key in ini){\r\n        if(lineNames.indexOf(key)!==-1) {\r\n            sections[key] = ini[key];\r\n        }\r\n    }      \r\n    return sections;  \r\n}\r\n\r\nfunction load(ini, name, model){\r\n    var options = loadMapOptions(ini['Options']);\r\n    var additionalNodes = loadAdditionalNodes(ini['AdditionalNodes']);\r\n    var lines = loadMapLines(filterLineSections(ini, model), additionalNodes);\r\n    return new PmzScheme(name, name, options, lines);\r\n}\r\n\r\nfunction save(){\r\n    throw new TypeError('Not implemented');\r\n}\r\n\r\nmodule.exports.load = load;\r\n\r\nmodule.exports.save = save;\r\n\r\n\r\n\n},{\"../common/point\":1,\"../common/utils\":4,\"../model/additional-nodes\":6,\"../model/scheme\":10,\"../model/scheme-line\":9}],16:[function(require,module,exports){\n'use strict';\r\n\r\nvar PmzTransport = require('../model/transport');\r\n\r\n\r\nfunction loadTrpOptions(ini){\r\n    return {\r\n        type: ini['Type'] || 'Метро'\r\n    }\r\n}\r\n\r\nfunction loadTrpLines(cityDelays, ini){\r\n    var lines = {};\r\n    for(var key in ini){\r\n        var item = ini[key];\r\n\r\n        var delays = {};\r\n        if(item['Delays']){\r\n            var delayValues = item.Delays.split(',');\r\n            for(var i=0; i<cityDelays.length; i++){\r\n                delays[cityDelays[i]] = delayValues[i];\r\n            }\r\n        }\r\n        if(item['DelayDay']){\r\n            delays['Day'] =  item.DelayDay;\r\n        }\r\n\r\n        if(item['DelayNight']){\r\n            delays['Night'] =  item.DelayNight;\r\n        }\r\n\r\n        lines[item.Name] = {\r\n            sectionName: key,\r\n            lineMap: item['LineMap'],\r\n            stations: item['Stations'],\r\n            driving: item['Driving'],\r\n            delays: delays\r\n        }            \r\n\r\n    }\r\n    return lines;\r\n}\r\n\r\nfunction loadTrpTransfers(ini){\r\n    return ini;\r\n}\r\n\r\nfunction filterTrpLineSections(ini){\r\n    var sections = {};\r\n    for(var key in ini){\r\n        if(['Options','Transfers','AdditionalInfo'].indexOf(key)===-1) {\r\n            sections[key] = ini[key];                    \r\n        }\r\n    }\r\n    return sections;\r\n}\r\n\r\nfunction load(ini, name, metadata){\r\n    return new PmzTransport(name, name, \r\n        loadTrpOptions(ini['Options'] || {}),\r\n        loadTrpLines(metadata.delays, filterTrpLineSections(ini)),\r\n        loadTrpTransfers(ini['Transfers']|| {}));\r\n}\r\n\r\nfunction save(){\r\n    throw new TypeError('Not implemented');\r\n}\r\n\r\nmodule.exports.load = load;\r\n\r\nmodule.exports.save = save;\r\n\n},{\"../model/transport\":11}]},{},[5])(5)\n});"],"sourceRoot":"/source/"}